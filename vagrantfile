Vagrant.configure("2") do |config|
  # Common base image
  BASE_BOX = "ubuntu/jammy64"

  config.hostmanager.enabled = true
  config.hostmanager.manage_host = false
  config.hostmanager.manage_guest = true
  config.hostmanager.include_offline = true

  # ip_resolver for DHCP
  config.hostmanager.ip_resolver = proc do |machine|
    ip = `vagrant ssh #{machine.name} -c "hostname -I | awk '{print $2}'"`.strip
  end


  # ops VM
  config.vm.define "ops" do |ops|
    ops.vm.box = BASE_BOX
    ops.vm.hostname = "ops.local"
    ops.vm.network "private_network", type: "dhcp"
    ops.vm.network "public_network"

    ops.vm.provider "virtualbox" do |vb|
      vb.memory = 4096
      vb.cpus = 2
    end
  end

  # LB VM
  config.vm.define "lb" do |lb|
    lb.vm.box = BASE_BOX
    lb.vm.hostname = "lb.local"
    lb.vm.network "private_network", type: "dhcp"
    lb.vm.network "public_network"
    lb.vm.provision "shell" do |s|
ssh_pub_key = File.readlines("key/intern.pub").first.strip
s.inline = <<-SHELL
echo #{ssh_pub_key} >> /home/vagrant/.ssh/authorized_keys
SHELL
end
  end

 # DB VM
  config.vm.define "db" do |db|
    db.vm.box = BASE_BOX
    db.vm.hostname = "db.local"
    db.vm.network "private_network", type: "dhcp"
 db.vm.provision "shell" do |s|
ssh_pub_key = File.readlines("key/intern.pub").first.strip
s.inline = <<-SHELL
echo #{ssh_pub_key} >> /home/vagrant/.ssh/authorized_keys
SHELL
end
    
  end

 # web VM
  config.vm.define "web" do |web|
    web.vm.box = BASE_BOX
    web.vm.hostname = "web.local"
    web.vm.network "private_network", type: "dhcp"
 web.vm.provision "shell" do |s|
ssh_pub_key = File.readlines("key/intern.pub").first.strip
s.inline = <<-SHELL
echo #{ssh_pub_key} >> /home/vagrant/.ssh/authorized_keys
SHELL
end

 end

 # web2 VM
  config.vm.define "web2" do |web2|
    web2.vm.box = BASE_BOX
    web2.vm.hostname = "web2.local"
    web2.vm.network "private_network", type: "dhcp"
 web2.vm.provision "shell" do |s|
ssh_pub_key = File.readlines("key/intern.pub").first.strip
s.inline = <<-SHELL
echo #{ssh_pub_key} >> /home/vagrant/.ssh/authorized_keys
SHELL
end

 end

 # test VM
  config.vm.define "test" do |test|
    test.vm.box = BASE_BOX
    test.vm.hostname = "test.local"
    test.vm.network "private_network", type: "dhcp"
 test.vm.provision "shell" do |s|
ssh_pub_key = File.readlines("key/intern.pub").first.strip
s.inline = <<-SHELL
echo #{ssh_pub_key} >> /home/vagrant/.ssh/authorized_keys
sudo apt install lynis

SHELL
end
    
  end


    config.ansible.groups = {
      "lb"  => ["lb"],
      "ops" => ["ops"],
      "web" => ["web"],
      "db" => ["db"],

    }
#  end
end
